<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Apoio ao Fomento por Otimização - SAFO</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Estilos customizados para melhorar a aparência */
        body {
            background-color: #f8f9fa;
        }
        .header-ime {
            background-color: #004d99; 
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
            position: relative; 
        }
        .login-link {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-weight: bold;
            text-decoration: none;
            z-index: 1051; 
        }
        .login-link:hover {
            color: #ccc;
        }
        /* Classe para esconder vistas (Bootstrap helper) */
        .view-hidden {
            display: none !important;
        }
    </style>
</head>
<body>

    <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="loginModalLabel">Acesso ao SAFO</h5>
                </div>
                <div class="modal-body">
                    
                    <div id="login-view">
                        <p>Para receber notificações automáticas sobre novos editais, faça login.</p>
                        <form id="loginForm">
                            <div class="mb-3">
                                <label for="inputEmailLogin" class="form-label">E-mail</label>
                                <input type="email" class="form-control" id="inputEmailLogin" placeholder="seu.nome@ime.br" required>
                            </div>
                            <div class="mb-3">
                                <label for="inputPasswordLogin" class="form-label">Senha</label>
                                <input type="password" class="form-control" id="inputPasswordLogin" required>
                            </div>
                        </form>
                    </div>

                    <div id="cadastro-email-view" class="view-hidden">
                        <h6 class="mb-3">Criação de Conta (1 de 3)</h6>
                        <div class="mb-3">
                            <label for="inputEmailCadastro" class="form-label">Email para Cadastro</label>
                            <input type="email" class="form-control" id="inputEmailCadastro" placeholder="seu.novo.email@ime.br" required>
                        </div>
                    </div>

                    <div id="cadastro-senha-view" class="view-hidden">
                        <h6 class="mb-3">Criação de Conta (2 de 3)</h6>
                        <div class="mb-3">
                            <label for="inputNovaSenha" class="form-label">Nova Senha</label>
                            <input type="password" class="form-control" id="inputNovaSenha" required>
                            <small class="form-text text-muted">A senha deve ter mais de 4 caracteres, contendo apenas letras e números (sem caracteres especiais).</small>
                        </div>
                    </div>

                    <div id="cadastro-confirmacao-view" class="view-hidden">
                        <h6 class="mb-3">Criação de Conta (3 de 3)</h6>
                        <div class="mb-3">
                            <label for="inputConfirmaSenha" class="form-label">Confirmação da Senha</label>
                            <input type="password" class="form-control" id="inputConfirmaSenha" required>
                            <div id="senha-mismatch-alert" class="alert alert-danger mt-2 view-hidden">
                                <strong>Erro!</strong> Os campos de senha estão diferentes.
                            </div>
                        </div>
                    </div>

                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-secondary" id="btn-secundario" onclick="handleSecondaryAction()">Continuar sem Login</button>
                    <button type="button" class="btn btn-primary" id="btn-primario" onclick="handlePrimaryAction()">Fazer Login</button>
                </div>
            </div>
        </div>
    </div>
    <header class="header-ime text-center">
        <a href="#" class="login-link" data-bs-toggle="modal" data-bs-target="#loginModal" id="headerLoginLink">Fazer Login</a>
        
        <h1>Sistema de Apoio ao Fomento por Otimização - SAFO</h1> 
        <p class="lead" id="usuarioInfo">Dr. João Silva | Usuário Associado</p>
    </header>

    <div class="container">
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card p-3 shadow-sm">
                    <label for="selectLinha" class="form-label fs-5">
                        <strong>1. Selecione Sua Linha de Pesquisa (Programas de Pós-Graduação)</strong>
                    </label>
                    <select id="selectLinha" class="form-select form-select-lg" onchange="carregarEditais()">
                        <option value="">-- Escolha uma Linha de Pesquisa --</option>
                        <option value="cartografica">Programa de Engenharia Cartográfica</option>
                        <option value="defesa">Programa de Engenharia de Defesa</option>
                        <option value="eletrica">Programa de Engenharia Elétrica</option>
                        <option value="mecanica">Programa de Engenharia Mecânica</option>
                        <option value="nuclear">Programa de Engenharia Nuclear</option>
                        <option value="transportes">Programa de Engenharia de Transportes</option>
                        <option value="materiais">Programa de Pós-Graduação em Ciência e Engenharia de Materiais</option>
                        <option value="quimica">Programa de Engenharia Química</option>
                        <option value="sistemas">Programa de Sistemas e Computação</option>
                    </select>
                </div>
            </div>

            <div class="col-md-4 d-grid gap-2">
                <a href="#" class="btn btn-outline-primary btn-lg mt-4">
                    <strong>2. Inserir Novas Linhas de Pesquisa</strong>
                </a>
                <small class="text-muted text-center">Incremento solicitado</small>
            </div>
        </div>

        <hr>

        <h2 class="mt-4 mb-3">3. Sugestões de Editais Apropriados (Ordenados por Relevância)</h2>

        <div class="alert alert-info" id="mensagemAguarde" role="alert">
            Selecione uma linha de pesquisa acima para carregar os editais e seus **scores de relevância (IA)**.
        </div>
        
        <div class="alert alert-warning d-none" id="alertaNotificacao" role="alert">
            <h4 class="alert-heading">Atenção!</h4>
            <p>Você está navegando <strong>sem fazer login</strong>. Não receberá notificações por e-mail sobre novos editais. Clique em "Fazer Login" para ativar os alertas.</p>
        </div>

        <div class="table-responsive">
            <table class="table table-striped table-hover shadow-sm" id="tabelaEditais" style="display:none;">
                <thead class="table-dark">
                    <tr>
                        <th>Edital de Fomento</th>
                        <th>Agência</th>
                        <th>Data Limite</th>
                        <th>Score de Relevância (IA)</th>
                        <th>Ação</th>
                    </tr>
                </thead>
                <tbody id="corpoTabela">
                    </tbody>
            </table>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // -----------------------------------------------------
        // Variáveis de Estado
        // -----------------------------------------------------
        let usuarioLogado = false; 
        let currentView = 'login';
        const modalViews = ['login-view', 'cadastro-email-view', 'cadastro-senha-view', 'cadastro-confirmacao-view'];

        // Referências DOM
        const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
        const usuarioInfo = document.getElementById('usuarioInfo');
        const alertaNotificacao = document.getElementById('alertaNotificacao');
        const btnSecundario = document.getElementById('btn-secundario');
        const btnPrimario = document.getElementById('btn-primario');

        // Dados de Cadastro Temporários
        let novoEmail = '';
        let novaSenha = '';

        // -----------------------------------------------------
        // LÓGICA DE EXIBIÇÃO DE VISTAS (Views)
        // -----------------------------------------------------
        function showView(viewId) {
            modalViews.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.classList.add('view-hidden');
                }
            });
            document.getElementById(viewId).classList.remove('view-hidden');
            currentView = viewId.replace('-view', '');
            updateModalButtons();
        }

        function updateModalButtons() {
            // Reinicia o estado
            btnSecundario.classList.remove('d-none');
            btnPrimario.classList.remove('d-none');
            document.getElementById('senha-mismatch-alert').classList.add('view-hidden');

            // Define ações e textos com base na vista atual
            switch (currentView) {
                case 'login':
                    btnSecundario.textContent = 'Criar Conta';
                    btnSecundario.onclick = () => showView('cadastro-email-view');
                    btnPrimario.textContent = 'Fazer Login';
                    btnPrimario.onclick = fazerLogin;
                    break;
                case 'cadastro-email':
                    btnSecundario.textContent = 'Voltar';
                    btnSecundario.onclick = () => showView('login-view');
                    btnPrimario.textContent = 'Próximo';
                    btnPrimario.onclick = validarEmail;
                    break;
                case 'cadastro-senha':
                    btnSecundario.textContent = 'Voltar';
                    btnSecundario.onclick = () => showView('cadastro-email-view');
                    btnPrimario.textContent = 'Próximo';
                    btnPrimario.onclick = validarNovaSenha;
                    break;
                case 'cadastro-confirmacao':
                    btnSecundario.textContent = 'Voltar';
                    btnSecundario.onclick = () => showView('cadastro-senha-view');
                    btnPrimario.textContent = 'Criar Conta';
                    btnPrimario.onclick = validarConfirmacao;
                    break;
            }
        }

        // -----------------------------------------------------
        // LÓGICA DE CADASTRO E VALIDAÇÃO
        // -----------------------------------------------------
        
        function validarEmail() {
            const email = document.getElementById('inputEmailCadastro').value;
            if (email.length > 5 && email.includes('@')) {
                novoEmail = email;
                showView('cadastro-senha-view');
            } else {
                alert('Por favor, insira um e-mail válido para continuar.');
            }
        }

        function validarNovaSenha() {
            const senha = document.getElementById('inputNovaSenha').value;
            
            // Requisito 5: Senha deve ter mais de 4 caracteres, apenas letras e números.
            const regex = /^[a-zA-Z0-9]{5,}$/; 

            if (regex.test(senha)) {
                novaSenha = senha;
                showView('cadastro-confirmacao-view');
            } else {
                alert('A senha deve ter mais de 4 caracteres e conter apenas letras (maiúsculas/minúsculas) e números. Por favor, tente novamente.');
            }
        }

        function validarConfirmacao() {
            const confirmacao = document.getElementById('inputConfirmaSenha').value;
            const alerta = document.getElementById('senha-mismatch-alert');

            // Requisito 4: Comparação de senhas
            if (confirmacao !== novaSenha) {
                alerta.classList.remove('view-hidden');
                document.getElementById('inputConfirmaSenha').focus(); // Foca o usuário no campo de erro
            } else {
                alerta.classList.add('view-hidden');
                // Se as senhas baterem, completa o cadastro
                criarConta();
            }
        }

        function criarConta() {
            // AQUI O CÓDIGO REAL ENVIARIA novoEmail E novaSenha PARA O BACKEND
            
            alert(`Conta criada com sucesso para: ${novoEmail}! Por favor, faça login.`);
            // Limpa e retorna para a tela de login
            document.getElementById('inputEmailLogin').value = novoEmail;
            document.getElementById('inputPasswordLogin').value = '';
            showView('login-view');
        }

        // -----------------------------------------------------
        // LÓGICA DE LOGIN SIMULADO (MANTIDA)
        // -----------------------------------------------------
        function fazerLogin() {
            const email = document.getElementById('inputEmailLogin').value;
            const senha = document.getElementById('inputPasswordLogin').value;

            // Simulação de autenticação (no sistema real, o backend faria isso)
            if (email && senha) {
                usuarioLogado = true;
                loginModal.hide();
                usuarioInfo.innerHTML = `Bem-vindo(a), ${email} | <strong>Notificações ATIVAS</strong>`;
                alertaNotificacao.classList.add('d-none');
                document.getElementById('headerLoginLink').onclick = fazerLogout; // Define a função de logout
                document.getElementById('headerLoginLink').textContent = 'Sair';
                alert("Login efetuado com sucesso! Você receberá alertas por e-mail.");
            } else {
                alert("Por favor, preencha E-mail e Senha para fazer login.");
            }
        }
        
        function fazerLogout() {
             usuarioLogado = false;
             usuarioInfo.innerHTML = `Navegando como Visitante | <strong>Notificações INATIVAS</strong>`;
             document.getElementById('headerLoginLink').onclick = () => loginModal.show(); // Volta a abrir o modal
             document.getElementById('headerLoginLink').textContent = 'Fazer Login';
             alertaNotificacao.classList.remove('d-none');
             showView('login-view'); // Garante que a tela de login seja a padrão
             alert("Você saiu do sistema.");
        }

        function handleSecondaryAction() {
            // Esta função lida com o botão "Continuar sem Login" apenas na tela de login
            if (currentView === 'login') {
                continuarSemLogin();
            } else {
                // Para as telas de cadastro, esta função é "Voltar" (já tratada em updateModalButtons)
            }
        }

        function handlePrimaryAction() {
             // Esta função lida com as ações primárias (Login, Próximo, Criar Conta)
             if (currentView === 'login') {
                 fazerLogin();
             } else if (currentView === 'cadastro-email') {
                 validarEmail();
             } else if (currentView === 'cadastro-senha') {
                 validarNovaSenha();
             } else if (currentView === 'cadastro-confirmacao') {
                 validarConfirmacao();
             }
        }

        function continuarSemLogin() {
            usuarioLogado = false;
            loginModal.hide();
            usuarioInfo.innerHTML = `Navegando como Visitante | <strong>Notificações INATIVAS</strong>`;
            alertaNotificacao.classList.remove('d-none');
            document.getElementById('headerLoginLink').onclick = () => loginModal.show();
            document.getElementById('headerLoginLink').textContent = 'Fazer Login';
        }
        
        // -----------------------------------------------------
        // INICIALIZAÇÃO E DADOS DA PÁGINA (MANTIDO)
        // -----------------------------------------------------
        
        // Dados e funções de carregar editais... (Mesmas do código anterior)
        const dadosEditais = {
            cartografica: [
                { nome: "Fomento em Geoprocessamento 2026", agencia: "CNPq", data: "01/11/2025", score: 93 },
                { nome: "Modelagem de Dados Espaciais", agencia: "FINEP", data: "15/12/2025", score: 85 },
            ],
            defesa: [
                { nome: "Pesquisa Estratégica Nacional", agencia: "MD/CNPq", data: "20/10/2025", score: 98 },
                { nome: "Tecnologias de Monitoramento", agencia: "CAPES", data: "05/11/2025", score: 90 },
            ],
            eletrica: [
                { nome: "Sistemas de Energia Inteligente", agencia: "FAPESP", data: "10/11/2025", score: 95 },
                { nome: "Eletrônica de Potência", agencia: "FINEP", data: "01/12/2025", score: 80 },
            ],
            mecanica: [
                { nome: "Desenvolvimento de Máquinas", agencia: "BNDES", data: "25/10/2025", score: 88 },
            ],
            nuclear: [
                { nome: "Segurança e Aplicações Nucleares", agencia: "CNEN", data: "15/11/2025", score: 99 },
                { nome: "Novas Fontes de Energia", agencia: "FAPERJ", data: "01/12/2025", score: 78 },
            ],
            transportes: [
                { nome: "Logística e Otimização 2025", agencia: "FINEP", data: "01/10/2025", score: 91 },
                { nome: "Fluxo e Tráfego", agencia: "CNPq", data: "01/12/2025", score: 85 },
            ],
            materiais: [
                { nome: "Pesquisa em Materiais Avançados", agencia: "FAPESP", data: "05/11/2025", score: 96 },
            ],
            quimica: [
                { nome: "Química Sustentável", agencia: "CAPES", data: "15/11/2025", score: 89 },
            ],
            sistemas: [
                { nome: "Chamada Universal CNPq 2026", agencia: "CNPq", data: "15/10/2025", score: 92 },
                { nome: "Pesquisa Básica em IA", agencia: "FAPESP", data: "20/11/2025", score: 88 },
            ]
        };

        function carregarEditais() {
            const linhaSelecionada = document.getElementById('selectLinha').value;
            const corpoTabela = document.getElementById('corpoTabela');
            const tabela = document.getElementById('tabelaEditais');
            const mensagem = document.getElementById('mensagemAguarde');
            
            corpoTabela.innerHTML = ''; 
            tabela.style.display = 'none';

            if (!linhaSelecionada) {
                mensagem.style.display = 'block';
                return;
            }

            mensagem.style.display = 'none';

            let editais = dadosEditais[linhaSelecionada] || [];

            editais.sort((a, b) => b.score - a.score);

            if (editais.length === 0) {
                corpoTabela.innerHTML = '<tr><td colspan="5" class="text-center">Nenhum edital encontrado para esta linha.</td></tr>';
            } else {
                editais.forEach(edital => {
                    const corScore = edital.score >= 90 ? 'text-success fw-bold' : edital.score >= 70 ? 'text-warning fw-bold' : 'text-muted';
                    const linha = `
                        <tr>
                            <td>${edital.nome}</td>
                            <td>${edital.agencia}</td>
                            <td>${edital.data}</td>
                            <td class="${corScore}">${edital.score}%</td>
                            <td><button class="btn btn-sm btn-info">Detalhes</button></td>
                        </tr>
                    `;
                    corpoTabela.innerHTML += linha;
                });
            }
            
            tabela.style.display = 'table';
        }
    </script>
</body>
</html>